name: æ„å»ºå’Œå‘å¸ƒ MacOSæ ¡å®æ‰“å°ç»„ä»¶

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½®æƒé™
permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºrelease
  actions: read
  checks: read

# å¹¶å‘æ§åˆ¶ - å…è®¸å–æ¶ˆæ­£åœ¨è¿è¡Œçš„å·¥ä½œæµ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
    # ç¬¬ä¸€é˜¶æ®µï¼šIntelæ„å»º
  build-intel:
    name: ğŸ”¨ æ„å»º Intel ç‰ˆæœ¬  
    runs-on: macos-13
    timeout-minutes: 30
    
    steps:
    - name: ğŸš€ å¼€å§‹Intelæ„å»º
      run: |
        echo "========== Intelæ„å»ºå¼€å§‹ =========="
        echo "â° å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ—ï¸ Runnerç¯å¢ƒ: $(uname -m)"
        echo "ğŸ–¥ï¸ ç³»ç»Ÿç‰ˆæœ¬: $(sw_vers -productVersion)"
        echo "ğŸ¯ ç›®æ ‡æ¶æ„: Intel (amd64)"
        echo "ğŸ“Š å¯ç”¨å†…å­˜: $(vm_stat | grep 'Pages free' | awk '{print $3}' | sed 's/\.//')é¡µ"
        echo "ğŸ’½ å¯ç”¨ç£ç›˜: $(df -h / | tail -1 | awk '{print $4}')"
        echo "ğŸ› ï¸ HomebrewçŠ¶æ€: $(brew --version | head -1)"
        echo "=================================="
    
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: è®¾ç½®Intelæ„å»ºç¯å¢ƒ
      run: |
        echo "è®¾ç½®Intelå…¼å®¹æ€§ç¯å¢ƒ..."
        echo "MACOSX_DEPLOYMENT_TARGET=10.13" >> $GITHUB_ENV
        echo "CGO_CFLAGS=-mmacosx-version-min=10.13" >> $GITHUB_ENV
        echo "CGO_LDFLAGS=-mmacosx-version-min=10.13" >> $GITHUB_ENV
        echo "âœ… Intelç‰ˆæœ¬ç›®æ ‡ç³»ç»Ÿ: macOS 10.13+"

    - name: ç¼–è¯‘é™æ€Intelç‰ˆsocat
      run: |
        echo "========== ç¼–è¯‘é™æ€Intelç‰ˆsocat =========="
        
        # ç¡®ä¿Xcode Command Line Toolså¯ç”¨
        xcode-select --install 2>/dev/null || echo "Xcode CLI tools already installed"
        
        # å®‰è£…ç¼–è¯‘ä¾èµ–
        brew install autoconf automake libtool
        
        # ä¸‹è½½socatæºç 
        SOCAT_VERSION="1.8.0.0"
        curl -L -o socat-${SOCAT_VERSION}.tar.gz http://www.dest-unreach.org/socat/download/socat-${SOCAT_VERSION}.tar.gz
        tar -xzf socat-${SOCAT_VERSION}.tar.gz
        cd socat-${SOCAT_VERSION}
        
        # ç®€åŒ–çš„é™æ€ç¼–è¯‘é…ç½®
        echo "ğŸ”§ é…ç½®é™æ€ç¼–è¯‘..."
        export CC="clang"
        export CFLAGS="-mmacosx-version-min=10.13 -arch x86_64 -O2"
        export LDFLAGS="-mmacosx-version-min=10.13 -arch x86_64"
        
        # æ›´ç®€å•çš„configureé…ç½®
        ./configure \
          --prefix=/tmp/socat-static \
          --disable-readline \
          --disable-openssl \
          --disable-libwrap \
          --disable-pty \
          --disable-ext2 \
          --disable-socks4 \
          --disable-socks4a \
          --disable-proxy \
          --disable-tcpwrap
        
        # ç¼–è¯‘
        echo "ğŸ”¨ ç¼–è¯‘socat..."
        make -j$(sysctl -n hw.ncpu) || make  # å¦‚æœå¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹
        
        # æ‰‹åŠ¨å®‰è£…
        mkdir -p /tmp/socat-static/bin
        cp socat /tmp/socat-static/bin/
        
        # éªŒè¯ç¼–è¯‘ç»“æœ
        STATIC_SOCAT="/tmp/socat-static/bin/socat"
        echo "ğŸ“ ç¼–è¯‘çš„socatä½ç½®: $STATIC_SOCAT"
        file "$STATIC_SOCAT"
        
        # æ£€æŸ¥ä¾èµ–ï¼ˆåº”è¯¥ä¸»è¦æ˜¯ç³»ç»Ÿåº“ï¼‰
        echo "ğŸ” æ£€æŸ¥ä¾èµ–åº“:"
        otool -L "$STATIC_SOCAT" | head -10
        
        # æµ‹è¯•åŸºæœ¬åŠŸèƒ½
        "$STATIC_SOCAT" -V
        
        # å‡†å¤‡æ–‡ä»¶
        mkdir -p ../build-assets
        cp "$STATIC_SOCAT" ../build-assets/socat
        chmod +x ../build-assets/socat
        
        echo "âœ… Intelç‰ˆsocatç¼–è¯‘å®Œæˆ"
        cd ..

    - name: æ„å»ºIntelåº”ç”¨ç¨‹åº
      run: |
        APP_NAME="MacOSæ ¡å®æ‰“å°ç»„ä»¶"
        BUILD_DIR="build-amd64"
        mkdir -p "$BUILD_DIR"
        
        echo "ğŸ”¨ æ„å»ºIntelç‰ˆæœ¬..."
        go build -ldflags="-s -w" -o "$BUILD_DIR/$APP_NAME" .
        
        echo "ğŸ“‹ å¤åˆ¶å¿…éœ€æ–‡ä»¶..."
        cp config.yaml "$BUILD_DIR/" 2>/dev/null || echo "âš ï¸ config.yamlä¸å­˜åœ¨"
        cp hprt-pos-printer-driver-v1.2.16.pkg "$BUILD_DIR/" 2>/dev/null || echo "âš ï¸ é©±åŠ¨æ–‡ä»¶ä¸å­˜åœ¨"
        cp build-assets/socat "$BUILD_DIR/"
        chmod +x "$BUILD_DIR/socat"
        
        # éªŒè¯socat
        echo "ğŸ” éªŒè¯bundled socat..."
        file "$BUILD_DIR/socat"
        echo "ä¾èµ–åº“åˆ—è¡¨:"
        otool -L "$BUILD_DIR/socat" | head -10
        
        echo "âœ… Intelç‰ˆæœ¬æ„å»ºå®Œæˆ"
        ls -la "$BUILD_DIR/"

    - name: åˆ›å»ºIntelå‹ç¼©åŒ…
      run: |
        TIMESTAMP=$(date '+%Y%m%d-%H%M')
        ZIP_NAME="MacOSæ ¡å®æ‰“å°ç»„ä»¶-Intel-${TIMESTAMP}.zip"
        cd build-amd64
        zip -r "../$ZIP_NAME" .
        cd ..
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
        echo "âœ… Intelå‹ç¼©åŒ…: $ZIP_NAME ($(ls -lh $ZIP_NAME | awk '{print $5}'))"

    - name: ä¸Šä¼ Inteläº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: macos-clodop-schoolpal-Intel
        path: ${{ env.ZIP_NAME }}

  # ç¬¬äºŒé˜¶æ®µï¼šARMæ„å»ºï¼ˆä¾èµ–Intelå®Œæˆï¼‰
  build-arm:
    name: ğŸ”¨ æ„å»º ARM ç‰ˆæœ¬  
    runs-on: macos-14
    timeout-minutes: 30
    needs: build-intel  # ç­‰å¾…Intelæ„å»ºå®Œæˆ
    
    steps:
    - name: ğŸš€ å¼€å§‹ARMæ„å»º
      run: |
        echo "========== ARMæ„å»ºå¼€å§‹ =========="
        echo "â° å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ—ï¸ Runnerç¯å¢ƒ: $(uname -m)"
        echo "ğŸ¯ ç›®æ ‡æ¶æ„: ARM (arm64)"
        echo "âŒ› Intelæ„å»ºçŠ¶æ€: ${{ needs.build-intel.result }}"
        echo "=================================="
    
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: è®¾ç½®ARMæ„å»ºç¯å¢ƒ
      run: |
        echo "è®¾ç½®ARMå…¼å®¹æ€§ç¯å¢ƒ..."
        echo "MACOSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV
        echo "CGO_CFLAGS=-mmacosx-version-min=11.0" >> $GITHUB_ENV
        echo "CGO_LDFLAGS=-mmacosx-version-min=11.0" >> $GITHUB_ENV
        echo "âœ… ARMç‰ˆæœ¬ç›®æ ‡ç³»ç»Ÿ: macOS 11.0+"

    - name: ç¼–è¯‘é™æ€ARMç‰ˆsocat
      run: |
        echo "========== ç¼–è¯‘é™æ€ARMç‰ˆsocat =========="
        
        # ç¡®ä¿Xcode Command Line Toolså¯ç”¨
        xcode-select --install 2>/dev/null || echo "Xcode CLI tools already installed"
        
        # å®‰è£…ç¼–è¯‘ä¾èµ–
        brew install autoconf automake libtool
        
        # ä¸‹è½½socatæºç 
        SOCAT_VERSION="1.8.0.0"
        curl -L -o socat-${SOCAT_VERSION}.tar.gz http://www.dest-unreach.org/socat/download/socat-${SOCAT_VERSION}.tar.gz
        tar -xzf socat-${SOCAT_VERSION}.tar.gz
        cd socat-${SOCAT_VERSION}
        
        # ç®€åŒ–çš„ARMç¼–è¯‘é…ç½®
        echo "ğŸ”§ é…ç½®ARMç¼–è¯‘..."
        export CC="clang"
        export CFLAGS="-mmacosx-version-min=11.0 -arch arm64 -O2"
        export LDFLAGS="-mmacosx-version-min=11.0 -arch arm64"
        
        # æ›´ç®€å•çš„configureé…ç½®
        ./configure \
          --prefix=/tmp/socat-static \
          --disable-readline \
          --disable-openssl \
          --disable-libwrap \
          --disable-pty \
          --disable-ext2 \
          --disable-socks4 \
          --disable-socks4a \
          --disable-proxy \
          --disable-tcpwrap
        
        # ç¼–è¯‘
        echo "ğŸ”¨ ç¼–è¯‘ARMç‰ˆsocat..."
        make -j$(sysctl -n hw.ncpu) || make  # å¦‚æœå¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹
        
        # æ‰‹åŠ¨å®‰è£…
        mkdir -p /tmp/socat-static/bin
        cp socat /tmp/socat-static/bin/
        
        # éªŒè¯ç¼–è¯‘ç»“æœ
        STATIC_SOCAT="/tmp/socat-static/bin/socat"
        echo "ğŸ“ ç¼–è¯‘çš„socatä½ç½®: $STATIC_SOCAT"
        file "$STATIC_SOCAT"
        
        # æ£€æŸ¥ä¾èµ–ï¼ˆåº”è¯¥ä¸»è¦æ˜¯ç³»ç»Ÿåº“ï¼‰
        echo "ğŸ” æ£€æŸ¥ä¾èµ–åº“:"
        otool -L "$STATIC_SOCAT" | head -10
        
        # æµ‹è¯•åŸºæœ¬åŠŸèƒ½
        "$STATIC_SOCAT" -V
        
        # å‡†å¤‡æ–‡ä»¶
        mkdir -p ../build-assets
        cp "$STATIC_SOCAT" ../build-assets/socat
        chmod +x ../build-assets/socat
        
        echo "âœ… ARMç‰ˆsocatç¼–è¯‘å®Œæˆ"
        cd ..

    - name: æ„å»ºARMåº”ç”¨ç¨‹åº
      run: |
        APP_NAME="MacOSæ ¡å®æ‰“å°ç»„ä»¶"
        BUILD_DIR="build-arm64"
        mkdir -p "$BUILD_DIR"
        
        echo "ğŸ”¨ æ„å»ºARMç‰ˆæœ¬..."
        go build -ldflags="-s -w" -o "$BUILD_DIR/$APP_NAME" .
        
        echo "ğŸ“‹ å¤åˆ¶å¿…éœ€æ–‡ä»¶..."
        cp config.yaml "$BUILD_DIR/" 2>/dev/null || echo "âš ï¸ config.yamlä¸å­˜åœ¨"
        cp hprt-pos-printer-driver-v1.2.16.pkg "$BUILD_DIR/" 2>/dev/null || echo "âš ï¸ é©±åŠ¨æ–‡ä»¶ä¸å­˜åœ¨"
        cp build-assets/socat "$BUILD_DIR/"
        chmod +x "$BUILD_DIR/socat"
        
        # éªŒè¯socat
        echo "ğŸ” éªŒè¯bundled socat..."
        file "$BUILD_DIR/socat"
        echo "ä¾èµ–åº“åˆ—è¡¨:"
        otool -L "$BUILD_DIR/socat" | head -10
        
        echo "âœ… ARMç‰ˆæœ¬æ„å»ºå®Œæˆ"
        ls -la "$BUILD_DIR/"

    - name: åˆ›å»ºARMå‹ç¼©åŒ…
      run: |
        TIMESTAMP=$(date '+%Y%m%d-%H%M')
        ZIP_NAME="MacOSæ ¡å®æ‰“å°ç»„ä»¶-ARM-${TIMESTAMP}.zip"
        cd build-arm64
        zip -r "../$ZIP_NAME" .
        cd ..
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
        echo "âœ… ARMå‹ç¼©åŒ…: $ZIP_NAME ($(ls -lh $ZIP_NAME | awk '{print $5}'))"

    - name: ä¸Šä¼ ARMäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: macos-clodop-schoolpal-ARM
        path: ${{ env.ZIP_NAME }}


  # å‘å¸ƒæ±‡æ€»
  release:
    name: ğŸ“¦ åˆ›å»ºå‘å¸ƒ
    needs: [build-intel, build-arm]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') && always()
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰äº§ç‰©
      uses: actions/download-artifact@v4
      
    - name: åˆ›å»ºå‘å¸ƒ
      if: ${{ needs.build-intel.result == 'success' && needs.build-arm.result == 'success' }}
      uses: softprops/action-gh-release@v1
      with:
        files: |
          macos-clodop-schoolpal-Intel/*
          macos-clodop-schoolpal-ARM/*
        name: MacOSæ ¡å®æ‰“å°ç»„ä»¶ ${{ github.ref_name }}
        body: |
          ## ğŸ‰ MacOSæ ¡å®æ‰“å°ç»„ä»¶ ${{ github.ref_name }}
          
          **âœ… æ„å»ºçŠ¶æ€**: 
          - Intelç‰ˆæœ¬: ${{ needs.build-intel.result }}
          - ARMç‰ˆæœ¬: ${{ needs.build-arm.result }}
          
          **ğŸ“¥ ä¸‹è½½è¯´æ˜**:
          - Intel Macç”¨æˆ·: ä¸‹è½½ `MacOSæ ¡å®æ‰“å°ç»„ä»¶-Intel-*.zip`
          - Apple Silicon Macç”¨æˆ·: ä¸‹è½½ `MacOSæ ¡å®æ‰“å°ç»„ä»¶-ARM-*.zip`
          
          **ğŸš€ æ–°ç‰¹æ€§**:
          - âœ… å®Œå…¨ç‹¬ç«‹è¿è¡Œï¼Œæ— éœ€å®‰è£…ä»»ä½•ä¾èµ–
          - âœ… å†…ç½®é™æ€ç¼–è¯‘çš„socatï¼Œè§£å†³åŠ¨æ€åº“ä¾èµ–é—®é¢˜
          - âœ… æ”¯æŒåœ¨ä»»ä½•macOSç³»ç»Ÿä¸Šç›´æ¥è¿è¡Œ
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 