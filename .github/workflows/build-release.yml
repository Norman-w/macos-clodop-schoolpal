name: æ„å»ºå’Œå‘å¸ƒ MacOSæ ¡å®æ‰“å°ç»„ä»¶

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½®æƒé™
permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºrelease
  actions: read
  checks: read

jobs:
  build:
    name: æ„å»º ${{ matrix.arch }} ç‰ˆæœ¬
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-12        # Intel Mac (æ›´ä½ç‰ˆæœ¬ä»¥ç¡®ä¿å…¼å®¹æ€§)
            arch: amd64
            arch_name: Intel
            runner_arch: x86_64
            min_os_version: "10.13"  # æ”¯æŒ High Sierra åŠä»¥ä¸Š
          - os: macos-14        # ARM Mac (M1)
            arch: arm64
            arch_name: ARM
            runner_arch: arm64
            min_os_version: "11.0"   # ARM Mac æœ€ä½ Big Sur

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: éªŒè¯æ¶æ„
      run: |
        echo "========== æ„å»ºç¯å¢ƒä¿¡æ¯ =========="
        echo "å½“å‰è¿è¡Œç¯å¢ƒæ¶æ„: $(uname -m)"
        echo "ç›®æ ‡æ„å»ºæ¶æ„: ${{ matrix.arch }}"
        echo "æ„å»ºå¹³å°: ${{ matrix.arch_name }}"
        echo "æ“ä½œç³»ç»Ÿ: $(sw_vers -productName) $(sw_vers -productVersion)"
        echo "Go ç‰ˆæœ¬: $(go version)"
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "ç£ç›˜ç©ºé—´: "
        df -h
        echo "=================================="

    - name: å®‰è£…å’Œè·å– socat
      run: |
        echo "========== å®‰è£…å’Œé…ç½® socat =========="
        echo "å¼€å§‹å®‰è£… socat..."
        
        # æ›´æ–° Homebrewï¼ˆå¦‚æœéœ€è¦ï¼‰
        echo "æ›´æ–° Homebrew..."
        brew update
        
        echo "å®‰è£… socat..."
        brew install socat
        
        echo "éªŒè¯ socat å®‰è£…..."
        socat -V | head -3
        
        echo "è·å– socat äºŒè¿›åˆ¶æ–‡ä»¶ä½ç½®..."
        SOCAT_PATH=$(which socat)
        echo "socat ä½ç½®: $SOCAT_PATH"
        echo "socat å¤§å°: $(ls -lh $SOCAT_PATH | awk '{print $5}')"
        
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p build-assets
        
        # å¤åˆ¶ socat åˆ°æ„å»ºèµ„æºç›®å½•
        cp "$SOCAT_PATH" build-assets/socat
        
        # éªŒè¯å¤åˆ¶çš„ socat
        echo "éªŒè¯å¤åˆ¶çš„ socat:"
        ls -la build-assets/socat
        chmod +x build-assets/socat
        ./build-assets/socat -V | head -3
        
        echo "âœ“ socat å‡†å¤‡å®Œæˆ"
        echo "==============================="

    - name: è®¾ç½®æ„å»ºç¯å¢ƒ
      run: |
        echo "è®¾ç½®ä¸­æ–‡è¯­è¨€ç¯å¢ƒ..."
        export LC_ALL=zh_CN.UTF-8
        export LANG=zh_CN.UTF-8
        echo "LC_ALL=zh_CN.UTF-8" >> $GITHUB_ENV
        echo "LANG=zh_CN.UTF-8" >> $GITHUB_ENV
        
        echo "è®¾ç½®macOSå…¼å®¹æ€§..."
        if [[ "${{ matrix.arch }}" == "amd64" ]]; then
          # è®¾ç½®Intelç‰ˆæœ¬çš„æœ€ä½ç³»ç»Ÿè¦æ±‚ä¸º macOS 10.13
          echo "MACOSX_DEPLOYMENT_TARGET=10.13" >> $GITHUB_ENV
          echo "CGO_CFLAGS=-mmacosx-version-min=10.13" >> $GITHUB_ENV
          echo "CGO_LDFLAGS=-mmacosx-version-min=10.13" >> $GITHUB_ENV
          echo "âœ“ Intelç‰ˆæœ¬ç›®æ ‡ç³»ç»Ÿ: macOS 10.13+"
        else
          # ARMç‰ˆæœ¬æœ€ä½ä¸º macOS 11.0 (Big Sur)
          echo "MACOSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV
          echo "CGO_CFLAGS=-mmacosx-version-min=11.0" >> $GITHUB_ENV  
          echo "CGO_LDFLAGS=-mmacosx-version-min=11.0" >> $GITHUB_ENV
          echo "âœ“ ARMç‰ˆæœ¬ç›®æ ‡ç³»ç»Ÿ: macOS 11.0+"
        fi

    - name: æ„å»ºåº”ç”¨ç¨‹åº
      run: |
        echo "========== å¼€å§‹æ„å»ºåº”ç”¨ç¨‹åº =========="
        echo "æ„å»ºå¹³å°: ${{ matrix.arch_name }} (${{ matrix.arch }})"
        echo "æ„å»ºæ—¶é—´: $(date)"
        
        # è®¾ç½®åº”ç”¨ç¨‹åºåç§°
        APP_NAME="MacOSæ ¡å®æ‰“å°ç»„ä»¶"
        BUILD_DIR="build-${{ matrix.arch }}"
        
        echo "åº”ç”¨ç¨‹åºåç§°: $APP_NAME"
        echo "æ„å»ºç›®å½•: $BUILD_DIR"
        
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p "$BUILD_DIR"
        echo "âœ“ æ„å»ºç›®å½•åˆ›å»ºå®Œæˆ"
        
        # æ„å»ºåº”ç”¨ç¨‹åº (ä½¿ç”¨å…¼å®¹æ€§è®¾ç½®)
        echo "æ„å»ºå‚æ•°ï¼š"
        echo "  MACOSX_DEPLOYMENT_TARGET: $MACOSX_DEPLOYMENT_TARGET"
        echo "  CGO_CFLAGS: $CGO_CFLAGS"
        echo "  CGO_LDFLAGS: $CGO_LDFLAGS"
        
        go build -ldflags="-s -w" -o "$BUILD_DIR/$APP_NAME" .
        
        BUILD_EXIT_CODE=$?
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "âœ“ ${{ matrix.arch_name }} ç‰ˆæœ¬æ„å»ºæˆåŠŸ"
        else
          echo "âœ— ${{ matrix.arch_name }} ç‰ˆæœ¬æ„å»ºå¤±è´¥ (é€€å‡ºç : $BUILD_EXIT_CODE)"
          exit 1
        fi
        
        # å¤åˆ¶å¿…éœ€æ–‡ä»¶
        echo "å¤åˆ¶å¿…éœ€æ–‡ä»¶..."
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        if [ -f "config.yaml" ]; then
          cp "config.yaml" "$BUILD_DIR/"
          echo "âœ“ å¤åˆ¶ config.yaml"
        fi
        
        # å¤åˆ¶é©±åŠ¨ç¨‹åº
        if [ -f "hprt-pos-printer-driver-v1.2.16.pkg" ]; then
          cp "hprt-pos-printer-driver-v1.2.16.pkg" "$BUILD_DIR/"
          echo "âœ“ å¤åˆ¶ HPRTé©±åŠ¨ç¨‹åº"
        fi
        
        # å¤åˆ¶ socat
        if [ -f "build-assets/socat" ]; then
          cp "build-assets/socat" "$BUILD_DIR/"
          chmod +x "$BUILD_DIR/socat"
          echo "âœ“ å¤åˆ¶ socat (å¤§å°: $(ls -lh $BUILD_DIR/socat | awk '{print $5}'))"
        else
          echo "âŒ socat æ–‡ä»¶ä¸å­˜åœ¨!"
          exit 1
        fi
        
        # éªŒè¯æ‰€æœ‰æ–‡ä»¶
        echo ""
        echo "========== æ„å»ºå†…å®¹éªŒè¯ =========="
        echo "æ„å»ºç›®å½•å†…å®¹:"
        ls -la "$BUILD_DIR/"
        echo ""
        echo "æ–‡ä»¶å¤§å°æ±‡æ€»:"
        du -h "$BUILD_DIR"/*
        echo "æ€»å¤§å°: $(du -sh "$BUILD_DIR" | cut -f1)"
        echo "==============================="
        
        # åˆ›å»º README
        cat > "$BUILD_DIR/README.txt" << EOF
        MacOSæ ¡å®æ‰“å°ç»„ä»¶ - ${{ matrix.arch_name }} ç‰ˆæœ¬ (${{ matrix.arch }})
        ================================================
        
                 æ„å»ºä¿¡æ¯ï¼š
         - æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')
         - æ„å»ºç¯å¢ƒ: GitHub Actions ${{ matrix.os }}
         - ç›®æ ‡æ¶æ„: ${{ matrix.arch }}
         - æœ€ä½ç³»ç»Ÿ: macOS ${{ matrix.min_os_version }}
         - Go ç‰ˆæœ¬: $(go version | cut -d' ' -f3)
        
        å®‰è£…è¯´æ˜ï¼š
        1. è¿è¡Œ "$APP_NAME" å¯åŠ¨é…ç½®å·¥å…·
        2. æŒ‰ç…§æ­¥éª¤å®Œæˆ HPRT æ‰“å°æœºé…ç½®
        3. å¦‚éœ€æ‰‹åŠ¨å®‰è£…é©±åŠ¨ï¼ŒåŒå‡» "hprt-pos-printer-driver-v1.2.16.pkg"
        
                 ç³»ç»Ÿè¦æ±‚ï¼š
         ${{ matrix.arch_name == 'ARM' && '- macOS 11.0 æˆ–æ›´é«˜ç‰ˆæœ¬' || '- macOS 10.13 æˆ–æ›´é«˜ç‰ˆæœ¬ (æ”¯æŒé»‘è‹¹æœ)' }}
         ${{ matrix.arch_name == 'ARM' && '- Apple Silicon å¤„ç†å™¨Mac (M1/M2/M3)' || '- Intel å¤„ç†å™¨Mac (åŒ…æ‹¬é»‘è‹¹æœ)' }}
        
        åŒ…å«ç»„ä»¶ï¼š
        - $APP_NAME: ä¸»é…ç½®å·¥å…·
        - config.yaml: åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶
        - hprt-pos-printer-driver-v1.2.16.pkg: HPRT æ‰“å°æœºé©±åŠ¨ç¨‹åº
        - socat: ç½‘ç»œä»£ç†å·¥å…· (é¢„è£…ï¼Œæ— éœ€ brew)
        
        è”ç³»æ–¹å¼ï¼š
        å¦‚æœ‰é—®é¢˜ï¼Œè¯·è®¿é—®ï¼šhttps://github.com/Norman-w/macos-clodop-schoolpal
        EOF
        
        echo "âœ“ åˆ›å»º README.txt"

    - name: åˆ›å»ºå‹ç¼©åŒ…
      run: |
        BUILD_DIR="build-${{ matrix.arch }}"
        TIMESTAMP=$(date '+%Y%m%d-%H%M')
        ZIP_NAME="MacOSæ ¡å®æ‰“å°ç»„ä»¶-${{ matrix.arch_name }}-${TIMESTAMP}.zip"
        
        echo "åˆ›å»ºå‹ç¼©åŒ…: $ZIP_NAME"
        cd "$BUILD_DIR"
        zip -r "../$ZIP_NAME" . -x "*.DS_Store"
        ZIP_EXIT_CODE=$?
        cd ..
        
        if [ $ZIP_EXIT_CODE -eq 0 ]; then
          echo "âœ“ å‹ç¼©åŒ…åˆ›å»ºæˆåŠŸ"
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          echo "å‹ç¼©åŒ…ä¿¡æ¯:"
          ls -lh "$ZIP_NAME"
        else
          echo "âœ— å‹ç¼©åŒ…åˆ›å»ºå¤±è´¥ (é€€å‡ºç : $ZIP_EXIT_CODE)"
          exit 1
        fi
        
        # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
        echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV
        
        # è¾“å‡ºæ„å»ºçŠ¶æ€ä¾›summaryä½¿ç”¨
        echo "BUILD_STATUS=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: macos-clodop-schoolpal-${{ matrix.arch_name }}
        path: |
          ${{ env.ZIP_NAME }}
          ${{ env.BUILD_DIR }}/

    - name: å‘å¸ƒåˆ° Release (ä»…æ ‡ç­¾è§¦å‘)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.ZIP_NAME }}
        name: MacOSæ ¡å®æ‰“å°ç»„ä»¶ ${{ github.ref_name }}
        body: |
          ## MacOSæ ¡å®æ‰“å°ç»„ä»¶ ${{ github.ref_name }}
          
          **æ„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          **ç‰ˆæœ¬è¯´æ˜**:
          - âœ… æ”¯æŒ Intel å’Œ ARM (Apple Silicon) æ¶æ„
          - âœ… åŒ…å« HPRT æ‰“å°æœºé©±åŠ¨ç¨‹åº
          - âœ… é¢„è£… socat ç½‘ç»œä»£ç†å·¥å…·ï¼ˆæ— éœ€ brewï¼‰
          - âœ… åŒ…å«ä¸­æ–‡å­—ä½“æ”¯æŒ
          - âœ… æ™ºèƒ½æ­¥éª¤æ£€æµ‹ï¼Œè·³è¿‡å·²å®Œæˆçš„é…ç½®
          
                     **ä¸‹è½½è¯´æ˜**:
           - Intel Mac ç”¨æˆ·è¯·ä¸‹è½½ `MacOSæ ¡å®æ‰“å°ç»„ä»¶-Intel-*.zip` (æ”¯æŒ macOS 10.13+ï¼ŒåŒ…æ‹¬é»‘è‹¹æœ)
           - Apple Silicon Mac ç”¨æˆ·è¯·ä¸‹è½½ `MacOSæ ¡å®æ‰“å°ç»„ä»¶-ARM-*.zip` (éœ€è¦ macOS 11.0+)
          
          **å®‰è£…æ­¥éª¤**:
          1. ä¸‹è½½å¯¹åº”æ¶æ„çš„å‹ç¼©åŒ…
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ "MacOSæ ¡å®æ‰“å°ç»„ä»¶" å¯åŠ¨é…ç½®å·¥å…·
          4. æŒ‰ç…§ç•Œé¢æç¤ºå®Œæˆé…ç½®
          
          å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/Norman-w/macos-clodop-schoolpal/issues) ä¸­åé¦ˆã€‚
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: æ„å»ºæ‘˜è¦
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: æ˜¾ç¤ºæ„å»ºç»“æœ
      run: |
        echo "## MacOSæ ¡å®æ‰“å°ç»„ä»¶æ„å»ºæ‘˜è¦"
        echo ""
        echo "### æ„å»ºçŠ¶æ€"
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        INTEL_RESULT=""
        ARM_RESULT=""
        OVERALL_SUCCESS=true
        
        # éå†æ„å»ºç»“æœ
        for result in ${{ join(needs.build.result, ' ') }}; do
          if [ "$result" != "success" ]; then
            OVERALL_SUCCESS=false
          fi
        done
        
        # æ£€æŸ¥æ¯ä¸ªjobçš„çŠ¶æ€
        if [ "${{ needs.build.result }}" == "success" ]; then
          echo "âœ… æ‰€æœ‰ç‰ˆæœ¬æ„å»ºæˆåŠŸ"
          echo ""
          echo "### ğŸ“¦ äº§ç‰©ä¸‹è½½"
          echo "æ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° GitHub Actions Artifacts"
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "ğŸš€ Release å·²è‡ªåŠ¨åˆ›å»º: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          fi
        else
          echo "âŒ æ„å»ºå¤±è´¥"
          echo "æ„å»ºçŠ¶æ€: ${{ needs.build.result }}"
          echo ""
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚"
          exit 1
        fi 