name: æ„å»ºå’Œå‘å¸ƒ MacOSæ ¡å®æ‰“å°ç»„ä»¶

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      build_mode:
        description: 'æ„å»ºæ¨¡å¼'
        required: true
        default: 'sequential'
        type: choice
        options:
        - sequential  # é¡ºåºæ‰§è¡Œï¼ˆæ¨èï¼‰
        - parallel    # å¹¶è¡Œæ‰§è¡Œ

# è®¾ç½®æƒé™
permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºrelease
  actions: read
  checks: read

# å¹¶å‘æ§åˆ¶ - å…è®¸å–æ¶ˆæ­£åœ¨è¿è¡Œçš„å·¥ä½œæµ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ç¬¬ä¸€é˜¶æ®µï¼šIntelæ„å»º
  build-intel:
    name: ğŸ”¨ æ„å»º Intel ç‰ˆæœ¬
    runs-on: macos-12
    timeout-minutes: 30
    
    steps:
    - name: ğŸš€ å¼€å§‹Intelæ„å»º
      run: |
        echo "========== Intelæ„å»ºå¼€å§‹ =========="
        echo "â° å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ—ï¸ Runnerç¯å¢ƒ: $(uname -m)"
        echo "ğŸ¯ ç›®æ ‡æ¶æ„: Intel (amd64)"
        echo "ğŸ“Š å¯ç”¨å†…å­˜: $(vm_stat | grep 'Pages free' | awk '{print $3}' | sed 's/\.//')é¡µ"
        echo "ğŸ’½ å¯ç”¨ç£ç›˜: $(df -h / | tail -1 | awk '{print $4}')"
        echo "=================================="
    
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: è®¾ç½®Intelæ„å»ºç¯å¢ƒ
      run: |
        echo "è®¾ç½®Intelå…¼å®¹æ€§ç¯å¢ƒ..."
        echo "MACOSX_DEPLOYMENT_TARGET=10.13" >> $GITHUB_ENV
        echo "CGO_CFLAGS=-mmacosx-version-min=10.13" >> $GITHUB_ENV
        echo "CGO_LDFLAGS=-mmacosx-version-min=10.13" >> $GITHUB_ENV
        echo "âœ… Intelç‰ˆæœ¬ç›®æ ‡ç³»ç»Ÿ: macOS 10.13+"

    - name: å®‰è£…Intelç‰ˆsocat
      run: |
        echo "========== å®‰è£…Intelç‰ˆsocat =========="
        brew install socat
        SOCAT_PATH=$(which socat)
        echo "ğŸ“ socatä½ç½®: $SOCAT_PATH"
        file "$SOCAT_PATH"
        mkdir -p build-assets
        cp "$SOCAT_PATH" build-assets/socat
        chmod +x build-assets/socat
        echo "âœ… Intelç‰ˆsocatå‡†å¤‡å®Œæˆ"

    - name: æ„å»ºIntelåº”ç”¨ç¨‹åº
      run: |
        APP_NAME="MacOSæ ¡å®æ‰“å°ç»„ä»¶"
        BUILD_DIR="build-amd64"
        mkdir -p "$BUILD_DIR"
        
        echo "ğŸ”¨ æ„å»ºIntelç‰ˆæœ¬..."
        go build -ldflags="-s -w" -o "$BUILD_DIR/$APP_NAME" .
        
        echo "ğŸ“‹ å¤åˆ¶å¿…éœ€æ–‡ä»¶..."
        cp config.yaml "$BUILD_DIR/" 2>/dev/null || echo "âš ï¸ config.yamlä¸å­˜åœ¨"
        cp hprt-pos-printer-driver-v1.2.16.pkg "$BUILD_DIR/" 2>/dev/null || echo "âš ï¸ é©±åŠ¨æ–‡ä»¶ä¸å­˜åœ¨"
        cp build-assets/socat "$BUILD_DIR/"
        chmod +x "$BUILD_DIR/socat"
        
        echo "ğŸ“¦ åˆ›å»ºREADME..."
        cat > "$BUILD_DIR/README.txt" << EOF
MacOSæ ¡å®æ‰“å°ç»„ä»¶ - Intelç‰ˆæœ¬
æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')
æ”¯æŒç³»ç»Ÿ: macOS 10.13+ (åŒ…æ‹¬é»‘è‹¹æœ)
EOF
        
        echo "âœ… Intelç‰ˆæœ¬æ„å»ºå®Œæˆ"
        ls -la "$BUILD_DIR/"

    - name: åˆ›å»ºIntelå‹ç¼©åŒ…
      run: |
        TIMESTAMP=$(date '+%Y%m%d-%H%M')
        ZIP_NAME="MacOSæ ¡å®æ‰“å°ç»„ä»¶-Intel-${TIMESTAMP}.zip"
        cd build-amd64
        zip -r "../$ZIP_NAME" .
        cd ..
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
        echo "âœ… Intelå‹ç¼©åŒ…: $ZIP_NAME ($(ls -lh $ZIP_NAME | awk '{print $5}'))"

    - name: ä¸Šä¼ Inteläº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: macos-clodop-schoolpal-Intel
        path: ${{ env.ZIP_NAME }}

  # ç¬¬äºŒé˜¶æ®µï¼šARMæ„å»ºï¼ˆä¾èµ–Intelå®Œæˆï¼‰
  build-arm:
    name: ğŸ”¨ æ„å»º ARM ç‰ˆæœ¬  
    runs-on: macos-14
    timeout-minutes: 30
    needs: build-intel  # ç­‰å¾…Intelæ„å»ºå®Œæˆ
    # å¦‚æœæ‰‹åŠ¨é€‰æ‹©å¹¶è¡Œæ¨¡å¼ï¼Œåˆ™ä¸ä¾èµ–Intel
    if: ${{ github.event.inputs.build_mode != 'parallel' || github.event.inputs.build_mode == '' }}
    
    steps:
    - name: ğŸš€ å¼€å§‹ARMæ„å»º
      run: |
        echo "========== ARMæ„å»ºå¼€å§‹ =========="
        echo "â° å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ—ï¸ Runnerç¯å¢ƒ: $(uname -m)"
        echo "ğŸ¯ ç›®æ ‡æ¶æ„: ARM (arm64)"
        echo "âŒ› Intelæ„å»ºçŠ¶æ€: ${{ needs.build-intel.result }}"
        echo "=================================="
    
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Go ç¯å¢ƒ
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: è®¾ç½®ARMæ„å»ºç¯å¢ƒ
      run: |
        echo "è®¾ç½®ARMå…¼å®¹æ€§ç¯å¢ƒ..."
        echo "MACOSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV
        echo "CGO_CFLAGS=-mmacosx-version-min=11.0" >> $GITHUB_ENV
        echo "CGO_LDFLAGS=-mmacosx-version-min=11.0" >> $GITHUB_ENV
        echo "âœ… ARMç‰ˆæœ¬ç›®æ ‡ç³»ç»Ÿ: macOS 11.0+"

    - name: å®‰è£…ARMç‰ˆsocat
      run: |
        echo "========== å®‰è£…ARMç‰ˆsocat =========="
        brew install socat
        SOCAT_PATH=$(which socat)
        echo "ğŸ“ socatä½ç½®: $SOCAT_PATH"
        file "$SOCAT_PATH"
        mkdir -p build-assets
        cp "$SOCAT_PATH" build-assets/socat
        chmod +x build-assets/socat
        echo "âœ… ARMç‰ˆsocatå‡†å¤‡å®Œæˆ"

    - name: æ„å»ºARMåº”ç”¨ç¨‹åº
      run: |
        APP_NAME="MacOSæ ¡å®æ‰“å°ç»„ä»¶"
        BUILD_DIR="build-arm64"
        mkdir -p "$BUILD_DIR"
        
        echo "ğŸ”¨ æ„å»ºARMç‰ˆæœ¬..."
        go build -ldflags="-s -w" -o "$BUILD_DIR/$APP_NAME" .
        
        echo "ğŸ“‹ å¤åˆ¶å¿…éœ€æ–‡ä»¶..."
        cp config.yaml "$BUILD_DIR/" 2>/dev/null || echo "âš ï¸ config.yamlä¸å­˜åœ¨"
        cp hprt-pos-printer-driver-v1.2.16.pkg "$BUILD_DIR/" 2>/dev/null || echo "âš ï¸ é©±åŠ¨æ–‡ä»¶ä¸å­˜åœ¨"
        cp build-assets/socat "$BUILD_DIR/"
        chmod +x "$BUILD_DIR/socat"
        
        echo "ğŸ“¦ åˆ›å»ºREADME..."
        cat > "$BUILD_DIR/README.txt" << EOF
MacOSæ ¡å®æ‰“å°ç»„ä»¶ - ARMç‰ˆæœ¬
æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')
æ”¯æŒç³»ç»Ÿ: macOS 11.0+ (Apple Silicon)
EOF
        
        echo "âœ… ARMç‰ˆæœ¬æ„å»ºå®Œæˆ"
        ls -la "$BUILD_DIR/"

    - name: åˆ›å»ºARMå‹ç¼©åŒ…
      run: |
        TIMESTAMP=$(date '+%Y%m%d-%H%M')
        ZIP_NAME="MacOSæ ¡å®æ‰“å°ç»„ä»¶-ARM-${TIMESTAMP}.zip"
        cd build-arm64
        zip -r "../$ZIP_NAME" .
        cd ..
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
        echo "âœ… ARMå‹ç¼©åŒ…: $ZIP_NAME ($(ls -lh $ZIP_NAME | awk '{print $5}'))"

    - name: ä¸Šä¼ ARMäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: macos-clodop-schoolpal-ARM
        path: ${{ env.ZIP_NAME }}

  # å¹¶è¡Œæ„å»ºé€‰é¡¹ï¼ˆå¦‚æœç”¨æˆ·é€‰æ‹©ï¼‰
  build-parallel:
    name: ğŸ”¨ å¹¶è¡Œæ„å»º ${{ matrix.arch_name }} ç‰ˆæœ¬
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    if: ${{ github.event.inputs.build_mode == 'parallel' }}
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        include:
          - os: macos-12
            arch: amd64
            arch_name: Intel
          - os: macos-14
            arch: arm64
            arch_name: ARM
    
    steps:
    - name: ğŸš€ å¼€å§‹å¹¶è¡Œæ„å»º
      run: |
        echo "========== ${{ matrix.arch_name }}å¹¶è¡Œæ„å»ºå¼€å§‹ =========="
        echo "â° å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ—ï¸ Runnerç¯å¢ƒ: $(uname -m)"
        echo "ğŸ¯ ç›®æ ‡æ¶æ„: ${{ matrix.arch_name }}"
        echo "=================================="
    
    # è¿™é‡Œå¯ä»¥å¤ç”¨ä¹‹å‰çš„æ„å»ºæ­¥éª¤...
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    # ... å…¶ä»–æ­¥éª¤

  # å‘å¸ƒæ±‡æ€»
  release:
    name: ğŸ“¦ åˆ›å»ºå‘å¸ƒ
    needs: [build-intel, build-arm]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') && always()
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰äº§ç‰©
      uses: actions/download-artifact@v4
      
    - name: åˆ›å»ºå‘å¸ƒ
      if: ${{ needs.build-intel.result == 'success' && needs.build-arm.result == 'success' }}
      uses: softprops/action-gh-release@v1
      with:
        files: |
          macos-clodop-schoolpal-Intel/*
          macos-clodop-schoolpal-ARM/*
        name: MacOSæ ¡å®æ‰“å°ç»„ä»¶ ${{ github.ref_name }}
        body: |
          ## ğŸ‰ MacOSæ ¡å®æ‰“å°ç»„ä»¶ ${{ github.ref_name }}
          
          **âœ… æ„å»ºçŠ¶æ€**: 
          - Intelç‰ˆæœ¬: ${{ needs.build-intel.result }}
          - ARMç‰ˆæœ¬: ${{ needs.build-arm.result }}
          
          **ğŸ“¥ ä¸‹è½½è¯´æ˜**:
          - Intel Macç”¨æˆ·: ä¸‹è½½ `MacOSæ ¡å®æ‰“å°ç»„ä»¶-Intel-*.zip`
          - Apple Silicon Macç”¨æˆ·: ä¸‹è½½ `MacOSæ ¡å®æ‰“å°ç»„ä»¶-ARM-*.zip`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 